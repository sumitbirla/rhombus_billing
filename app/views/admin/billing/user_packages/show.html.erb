<div class="pull-right">
  <h3 class="light" style="display: inline-block; margin: 8px 30px 0 0">Total: <%= number_to_currency @user_package.total_price %> / mo.</h3>
  <%= link_to "edit", edit_admin_billing_user_package_path(@user_package), class: "btn btn-sm btn-default" %>
</div>
<h2>[<%= @user_package.id %>] <%= @user_package.user %></h2>
<hr/>

<div class="row">
  <div class="col-md-6">
    <table class="table table-condensed table-bordered summary">
      <%= obj_property(@user_package, :user) { |x| link_to x.name, admin_system_user_path(x) }%>
      <%= obj_property @user_package, :package %>
      <%= obj_property @user_package, :rate %>
      <%= obj_property @user_package, :recurr_status %>
      <%= obj_property @user_package, :recurr_date %>
    </table>
  </div>
  
  <div class="col-md-6">
    <table class="table table-condensed table-bordered summary">
      <%= obj_property(@user_package, :package, label: "Base rate") { |x| x.price } %>
      <%= obj_property(@user_package, :total_price, label: "With extras") %>
      <%= obj_property(@user_package, :payments, label: "Balance") { |x| x.sum(:amount) } %>
    </table>
  </div>
</div>


<div class="row">
  <div class="col-md-12">
    <h4>Services</h4>
    <table class="table table-striped table-condensed">
      <tr>
        <th>Code</th>
        <th class="text-center">Included</th>
        <th class="text-center">Used</th>
        <th class="text-center">Rate</th>
        <th>Service Type</th>
      </tr>
      <% @user_package.services.each do |svc| %>
          <tr>
            <td><%= svc.service_type.code %></td>
            
            <td class="text-center"><%= svc.quantity %></td>
            <td class="text-center"><%= svc.used %></td>
            <td class="text-center">
              <% if svc.rate %>
                  <%= number_to_currency(svc.rate) %> / <%= svc.service_type.bill_frequency.downcase%>
              <% else %>
                  - included -
              <% end %>
            </td>
            <td>
              <%= svc.service_type.name %>
              <% if svc.items.length > 0 %>
              <small>
                &raquo; 
                <%= svc.items.collect { |x| x.item_id }.join(", ") %>
              </small>
              <% end %>
            </td>
          </tr>
      <% end %>
    </table>


    <h4>Payments</h4>
    <table class="table table-striped table-condensed">
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Memo</th>
        <th>Amount</th>
      </tr>
      <% @user_package.payments.order('created_at DESC').each do |payment| %>
          <tr>
            <td><%= payment.id %></td>
            <td><%= systime payment.created_at %></td>
            <td><%= payment.memo %></td>
            <td><%= number_to_currency(payment.amount) %></td>
          </tr>
      <% end %>
    </table>

  </div>
</div>  <!-- row -->


<%= content_for :title do %>
    <%= "Subscription ##{@user_package.id}" %>
<% end %>


<% content_for :menu do
  render "admin/shared/billing_menu"
end %>


<% content_for :breadcrumbs do %>
    <li><a href="#">Billing</a></li>
    <li><%= link_to "Subscriptions", admin_billing_user_packages_path %></li>
    <li class="active">Subscription #<%= @user_package.id %></li>
<% end %>
