<div class="pull-right">
  <%= link_to edit_admin_billing_invoice_path(@invoice), class: 'btn btn-default btn-sm' do %>
    <i class="fa fa-edit"></i> Edit
  <% end %>
  <%= link_to admin_billing_invoices_print_batch_path, class: 'print-link btn btn-default btn-sm', "print-format" => "pdf" do %>
    <i class="fa fa-print"></i> Print
  <% end %>
</div>

<h2>
  <span class='light pull-right'><%= @invoice.from_affiliate %> &nbsp; </span>
  Invoice #<%= @invoice.id %></h2>
  
<hr>

<div class="row">

  <div class="col-md-4">
    <div class="panel panel-success">
      <div class="panel-heading">Invoicee:</div>
      <div class="panel-body">
        <%= link_to_user_or_affiliate @invoice %><br/>
        <%= @invoice.affiliate.address_as_text(delimiter: "<br>") unless @invoice.affiliate.nil? %>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="panel panel-success">
      <div class="panel-heading">Payment:</div>
      <div class="panel-body">
        <table class="summary">
          <tr>
            <td>Amount</td>
            <td><%= number_to_currency(@invoice.amount) %></td>
          </tr>
          <tr>
            <td>Posted</td>
            <td><%= @invoice.post_date %></td>
          </tr>
          <% unless @invoice.paid %>
          <tr>
            <td>Due</td>
            <td><%= @invoice.due_date || "<span class='light'>- not set -</span>".html_safe %></td>
          </tr>
          <% end %>
          <tr>
            <td>Status</td>
            <td>
              <% if @invoice.paid %>
                <span class="label label-success">paid</span>
              <% elsif @invoice.due_date && (@invoice.due_date < Date.today) %>
                <span class="label label-danger">overdue</span>
              <% else %>
                <span class="label label-warning">unpaid</span>
              <% end %>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <% unless @invoice.note.blank? %>
  <div class="col-md-4">
    <div class="panel panel-success">
      <div class="panel-heading">Notes:</div>
      <div class="panel-body">
        <%= @invoice.note %>
      </div>
    </div>
  </div>
  <% end %>

</div>



<table class="table table-striped table-condensed table-bordered">
  <tr style="background-color: #eee;">
    <th>Date</th>
    <th>REF</th>
    <th>Transaction ID</th>
    <th>Item Number</th>
    <th>Description</th>
    <th style="text-align: center">Qty</th>
    <th>Memo</th>
    <th style="text-align: right">Amount</th>
  </tr>
  <% @invoice.payments.each do |pmt| 
    next if pmt.amount > 0.0 %>
  <tr>
    <%
    if pmt.payable_type == "ShipmentItem"
      si = ShipmentItem.find(pmt.payable_id)
    %>
      <td><%= si.shipment.ship_date %></td>
      <td><%= link_to si.shipment.to_s, admin_store_shipment_path(si.shipment) %></td>
      <td><%= pmt.transaction_id %></td>
      <td><%= si.order_item.item_number %></td>
      <td><%= si.order_item.item_description %></td>
      <td style="text-align: right"><%= si.quantity %></td>
    <% elsif pmt.payable_type == "Shipment" 
        shp = Shipment.find(pmt.payable_id) %>
      <td><%= shp.ship_date%></td>
      <td><%= link_to shp.to_s, admin_store_shipment_path(shp) %></td>
      <td><%= pmt.transaction_id %></td>
      <td>-</td>
      <td><%= shp.carrier%> <%= shp.ship_method %></td>
      <td style="text-align: right">1</td>
    <% end %>
    <td><%= pmt.memo.presence %></td>
    <td style="text-align: right"><%= number_to_currency(pmt.amount, negative_format: "(%u%n)") %></td>
  </td>
  <% end %>
  <tfoot>
  <tr>
    <td style="text-align: right" colspan="7"><b>Total:</b></td>
    <td style="text-align: right"><b><%= number_to_currency(@invoice.amount, negative_format: "(%u%n)") %></b></td>
  </tr>
  </tfoot>
</table>


<div class="row hidden-print">
  
  <div class="col-md-8 col-sm-12">
    <div class="panel panel-warning">
      <div class="panel-heading"><i class="fa fa-clock-o"></i> History:</div>
      <div class="panel-body">
       
        <table class="table table-condensed table-striped">
          <tr>
            <th>Timestamp</th>
            <th>IP Address</th>
            <th>User</th>
            <th>Event</th>
            <th>Data 1</th>
          </tr>
          <% @invoice.logs.each do |log| %>
          <tr>
            <td><%= systime log.timestamp %></td>
            <td><%= log.ip_address %></td>
            <td>
              <% if log.user %>
                <%= link_to log.user.name, admin_system_user_path(log.user) %>
              <% else %>
                <span class="light">- system -</span>
              <% end %>
            </td>
            <td><%= log.event.titlecase %></td>
            <td><%= log.data1 %></td>
          </tr>
          <% end%>
        </table>
        
      </div>
    </div>
  </div>
    
  <div class="col-md-4 col-sm-12">
    <div class="panel panel-warning">
      <div class="panel-heading">Email invoice:</div>
      <div class="panel-body">
        <form action='<%= admin_billing_invoices_email_batch_path %>' method="POST">
          <input name="authenticity_token" value="<%= form_authenticity_token %>" type="hidden">
          <input type="hidden" name="invoice_id[]" value="<%= @invoice.id %>"/>
          <input class="form-control" type="email" name="email_address" value="<%= @invoice.affiliate.invoice_email if @invoice.affiliate %>" placeholder="email address"/><br>
          <button class="btn btn-sm btn-success">Send Invoice</button>
        </form>
      </div>
    </div>
  </div>
</div>


<form id="frmBatch" action="" method="post">
	<%= token_tag %>
  <input type="hidden" name="printer_id" value=""/>
  <input type="hidden" name="invoice_id[]" value="<%= @invoice.id %>"/>
</form>


<% content_for :title do %>
	Invoice #<%= @invoice.id%>
<% end %>


<% content_for :breadcrumbs do %>
	<li><a href="#">eCommerce</a></li>
	<li><%= link_to "Invoices", admin_billing_invoices_path(paid: 0) %></li>
	<li class="active">Invoice #<%= @invoice.id%></li>
<% end %>